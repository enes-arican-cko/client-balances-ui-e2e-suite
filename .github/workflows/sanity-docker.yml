name: 🧪 E2E Sanity Tests (Docker)
run-name: Sanity Tests | ${{ inputs.env == '' && 'qa' || inputs.env}}
on:
  schedule:
    - cron: "0 6 * * 1-5" #scheduled to run on every weekday at 6 AM
  workflow_dispatch:
    inputs:
      env:
        description: "Env"
        required: true
        default: "sbox"
        type: choice
        options:
          - "qa"
          - "sbox"

jobs:
  sanity-tests:
    name: 🧪 Sanity Test
    timeout-minutes: 10
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.41.1-jammy
    strategy:
      fail-fast: false
      matrix:
        shard: [1/2, 2/2]
    steps:
      - name: ⬇️ Checkout repository
        uses: actions/checkout@v4

      - name: ⚙️ Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ⚙️ Install dependencies
        run: |
          echo "::group::npm clean install"
          npm ci
          echo "::endgroup::"
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1 # Skip downloading during yarn install
          # Download Playwright(PW) Browsers for specific-version. Each version of Playwright 
          # needs specific versions of Chromium, Webkit and Firefox, so defining version is necessary.
          # More details: https://gkushang.medium.com/playwright-failed-to-launch-browsers-how-to-solve-8b01d03fe5b9
          # NOTE: browser version mentioned below should match the docker image version mentioned above: "container > image"
          PLAYWRIGHT_BROWSERS_PATH: /usr/lib/playwright npm install playwright-chromium@1.41.0 

      - name: 🚀 Run Playwright tests
        run: TEST_ENV=${{ inputs.env == '' && 'sbox' || inputs.env}} npm run test:trace "tests/*" --shard ${{matrix.shard}}

      - name: ⬆️ Uploading artifact
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: all-blob-reports
          path: blob-report/
          retention-days: 1

  merge-reports-and-upload:
    name: 🗒️ Publish Test Report
    if: always()
    needs: [sanity-tests]
    runs-on: ubuntu-latest
    outputs:
      timestamp: ${{ steps.timestampid.outputs.timestamp }}

    steps:
      - name: ⬇️ Checkout repository
        uses: actions/checkout@v4

      - name: ⚙️ Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: ⚙️ Install dependencies
        run: |
          echo "::group::npm install"
          npm ci
          echo "::endgroup::"

      - name: ⚙️ Set a timestamp
        id: timestampid
        run: echo "timestamp=$(date --utc +%d%m%Y_%H%M%SZ)" >> "$GITHUB_OUTPUT"

        # we now download the reports uploaded previously to merge them and create one single html report
      - name: ⬇️ Download blob reports from GitHub Actions Artifacts
        uses: actions/download-artifact@v3
        with:
          name: all-blob-reports # name of the file stored as artifact (as uploaded at the previous job)
          path: downloaded-blob-reports # name of the folder where the download will be saved

      # Playwright will generate a report and store it inside a folder called '/playwright-report'
      - name: 🔄 Merge the reports into a single HTML Report
        run: npx playwright merge-reports --reporter html ./downloaded-blob-reports

      - name: 📑 Upload HTML report
        id: artifact-upload-step
        uses: actions/upload-artifact@v3
        with:
          name: html-report-${{ inputs.env == '' && 'sbox' || inputs.env}}_${{ steps.timestampid.outputs.timestamp }}
          path: playwright-report
          retention-days: 7